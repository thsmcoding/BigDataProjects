from __future__ import absolute_import

# The default socket timeout, used by httplib to indicate that no timeout was
# specified by the user
from socket import _GLOBAL_DEFAULT_TIMEOUT
import time

from ..exceptions import TimeoutStateError

# A sentinel value to indicate that no timeout was specified by the user in
# urllib3
_Default = object()


# Use time.monotonic if available.
current_time = getattr(time, "monotonic", time.time)


class Timeout(object):
    """ Timeout configuration.

    Timeouts can be defined as a default for a pool::

        timeout = Timeout(connect=2.0, read=7.0)
        http = PoolManager(timeout=timeout)
        response = http.request('GET', 'http://example.com/')

    Or per-request (which overrides the default for the pool)::

        response = http.request('GET', 'http://example.com/', timeout=Timeout(10))

    Timeouts can be disabled by setting all the parameters to ``None``::

        no_timeout = Timeout(connect=None, read=None)
        response = http.request('GET', 'http://example.com/, timeout=no_timeout)


    :param total:
        This combines the connect and read timeouts into one; the read timeout
        will be set to the time leftover from the connect attempt. In the
        event that both a connect timeout and a total are specified, or a read
        timeout and a total are specified, the shorter timeout will be applied.

        Defaults to None.

    :type total: integer, float, or None

    :param connect:
        The maximum amount of time (in seconds) to wait for a connection
        attempt to a server to succeed. Omitting the parameter will default the
        connect timeout to the system default, probably `the global default
        timeout in socket.py
        <http://hg.python.org/cpython/file/603b4d593758/Lib/socket.py#l535>`_.
        None will set an infinite timeout for connection attempts.

    :type connect: integer, float, or None

    :param read:
        The maximum amount of time (in seconds) to wait between consecutive
        read operations for a response from the server. Omitting the parameter
        will default the read timeout to the system default, probably `the
        global default timeout in socket.py
        <http://hg.python.org/cpython/file/603b4d593758/Lib/socket.py#l535>`_.
        None will set an infinite timeout.

    :type read: integer, float, or None

    .. note::

        Many factors can affect the total amount of time for urllib3 to return
        an HTTP response.

        For example, Python's DNS resolver does not obey the timeout specified
        on the socket. Other factors that can affect total request time include
        high CPU load, high swap, the program running at a low priority level,
        or other behaviors.

        In addition, the read and total timeouts only measure the time between
        read operations on the socket connecting the client and the server,
        not the total amount of time for the request to return a complete
        response. For most requests, the timeout is raised because the server
        has not sent the first byte in the specified time. This is not always
        the case; if a server streams one byte every fifteen seconds, a timeout
        of 20 seconds will not trigger, even though the request will take
        several minutes to complete.

        If your goal is to cut off any request after a set amount of wall clock
        time, consider having a second "watcher" thread to cut off a slow
        request.
    """

    #: A sentinel object representing the default timeout value
    DEFAULT_TIMEOUT = _GLOBAL_DEFAULT_TIMEOUT

    def __init__(self, total=None, connect=_Default, read=_Default):
        self._connect = self._validate_timeout(connect, "connect")
        self._read = self._validate_timeout(read, "read")
        self.total = self._validate_timeout(total, "total")
        self._start_connect = None

    def __str__(self):
        return "%s(connect=%r, read=%r, total=%r)" % (
            type(self).__name__,
            self._connect,
            self._read,
            self.total,
        )

    @classmethod
    def _validate_timeout(cls, value, name):
        """ Check that a timeout attribute is valid.

        :param value: The timeout value to validate
        :param name: The name of the timeout attribute to validate. This is
            used to specify in error messages.
        :return: The validated and casted version of the given value.
        :raises ValueError: If it is a numeric value less than or equal to
            zero, or the type is not an integer, float, or None.
        """
        if value is _Default:
            return cls.DEFAULT_TIMEOUT

        if value is None or value is cls.DEFAULT_TIMEOUT:
            return value

        if isinstance(value, bool):
            raise ValueError(
                "Timeout cannot be a boolean value. It must "
                "be an int, float or None."
            )
        try:
            float(value)
        except (TypeError, ValueError):
            raise ValueError(
                "Timeout value %s was %s, but it must be an "
                "int, float or None." % (name, value)
            )

        try:
            if value <= 0:
                raise ValueError(
                    "Attempted to set %s timeout to %s, but the "
                    "timeout cannot be set to a value less "
                    "than or equal to 0." % (name, value)
                )
        except TypeError:
            # Python 3
            raise ValueError(
                "Timeout value %s was %s, but it must be an "
                "int, float or None." % (name, value)
            )

        return value

    @classmethod
    def from_float(cls, timeout):
        """ Create a new Timeout from a legacy timeout value.

        The timeout value used by httplib.py sets the same timeout on the
        connect(), and recv() socket requests. This creates a :class:`Timeout`
        object that sets the individual timeouts to the ``timeout`` value
        passed to this function.

        :param timeout: The legacy timeout value.
        :type timeout: integer, float, sentinel default object, or None
        :return: Timeout object
        :rtype: :class:`Timeout`
        """
        return Timeout(read=timeout, connect=timeout)

    def clone(self):
        """ Create a copy of the timeout object

        Timeout properties are stored per-pool but each request needs a fresh
        Timeout object to ensure each one has its own start/stop configured.

        :return: a copy of the timeout object
        :rtype: :class:`Timeout`
        """
        # We can't use copy.deepcopy because that will also create a new object
        # for _GLOBAL_DEFAULT_TIMEOUT, which socket.py uses as a sentinel to
        # detect the user default.
        return Timeout(connect=self._connect, read=self._read, total=self.total)

    def start_connect(self):
        """ Start the timeout clock, used during a connect() attempt

        :raises urllib3.exceptions.TimeoutStateError: if you attempt
            to start a timer that has been started already.
        """
        if self._start_connect is not None:
            raise TimeoutStateError("Timeout timer has already been started.")
        self._start_connect = current_time()
        return self._start_connect

    def get_connect_duration(self):
        """ Gets the time elapsed since the call to :meth:`start_connect`.

        :return: Elapsed time in seconds.
        :rtype: float
        :raises urllib3.exceptions.TimeoutStateError: if you attempt
            to get duration for a timer that hasn't been started.
        """
        if self._start_connect is None:
            raise TimeoutStateError(
                "Can't get connect duration for timer that has not started."
            )
        return current_time() - self._start_connect

    @property
    def connect_timeout(self):
        """ Get the value to use when setting a connection timeout.

        This will be a positive float or integer, the value None
        (never timeout), or the default system timeout.

        :retur¡w™›‹Ÿ√ZxI?—°âcé3€båÙ¨≥∞∑πµ”ÌÓ⁄y.%Y!%~w‹9∫Smo,4˝_B·€πmÓ#ü˚JÂ$Ú÷(ˆ9_ìª≥ÄÇºdÁå»ÙÀõu‘Êí4ä˛›ö8√¶P8·õÖŒpqÄ3“π+§èŒKôØÆ÷Ê†ƒ¡ùúì…–9¸sœ ÏlËóÿ¥QIipHv√9∂!ˆÙ ˜Ír8¸1ZöBiëﬁAe¨…©Cyjãe`eI}÷f‡”ı8†®Æ£5»c≥í[∏x∏πù`0à[,‡åt€ÿ«>ıìdö•—ígb´yë›ÏR‰£v>P};ıÏ(4v›ïn,`][Rwë˜W\à";QA'8<å‰Áﬂ#<’MV÷ˇ MéﬁˆHÊùb∏WºTâA
Icåù›8¿Ù≈\U›»Q∑C°µˆõswq©8øYn•Fñkò;¶
á¯ïzdÙ¡ÙÀ=k€›lÍrD“Kt≥´Mp•U‘p£ÅÄF:Êµ.»—[πtY⁄?±Ÿÿ[∆òºæ¥ïZË\ÛÖT∆H9˘ècåÙë≠Y^Cp˜ãuzÌo+‹5Â∂.ÈêÆ8;Üz’\⁄Z√J«9bWQµäÊiÆ öxÊ	#Ns”∞¿«ˇ ¨÷∂ßk˛¢ñ™"[áÎÌGò1∏Åé !O Ùv.\Yœ¶ﬂi˙Öç›≈›ù˝Øõπ‰8$nO±ÎöéM:ÍÍ⁄˙ÌgÜí¡‚˚x*ÍÄåÖ»œ© ∫Ÿ÷ŒI/gÇÓÒPHë`ÑW<ñ9\îöéßFˆó<ãjÀ™L26A›í8˘πÁzVä´'ùjt√»˚-ù¯“˝ìŒÛT`Ç ‹±·z˚˚◊c·ˇ ⁄[_≈¨≠∫õ…&2Z∆A¬íKÄTü_¶:ÛQäE).ÊÌ§:ú7ç}êΩ›‰Íç"π$´åŒ9Ø°ØWMR6dHm íıt…l¶âî ≥8⁄X‹gÎT>feÈ∑ö≤G4lt¯’≠˛Dâ…êû)Ü œ_|˚RZY]jqoo2¡0X-l•óllK!ÂF=i5}
S–∆‘¢º“Øm4ãâ∑ïçÂ∂K\2™«ìç√Ç=)∂F˜Ps.°jÃ#∫O±‚.	$Ó›ÅÖ9Ï=O•CÉË«lôΩ®≠¨s\E4-mp˜HÕ∆√ èÔÙ#π>˝8ÆGƒ÷—[≈/ì3YFŒﬁt˚AW<)\uÁ?ïD≠}ìvhÛck.ôÚG©N±\(öK=™RFnK1√dˆ‡ÛÈö•§]¿ö⁄œ=ª=Â¨'ÀÑ°(≈’ì>ùå{“%=S;ÀHVÌÆ£y¬‹‹%å¿«±ˆ‡†$Úí}O•7U“Lﬂ`uºdëm’¸®eCÂ∂9@GÆ?)IË {»∂Ç}JHeiXYHñf|:…bﬂwp gúû‰ä‡óS≥‘5›WJ∂Ñ-¶ê~√®ÉF∏ï˛u|X®¿gåÿ÷7zÍ—±Õ·´k¯‰Ü‚˝cï.ƒÑª™`ß*ÿn‡Å≈g-§ãv≈Ê.® Õ<Éc‚!HÍN9ˇ dzR$À∫Eh˛|p=¬\q`"∆O ß5SM≥[]BT{hR£y≠/aì-	„1ûx èØç4îZπ®÷˙DWñw+níG7˙dâ≥nﬁJûÑå`z˚Ù¨ãÈÆ£¶.ó€]T•¿Tã/∞`ûÑ_^z–d_ÒEÉ‹Gm§0mFÍ˛5πÜ6¬è)\\Òéπı„ékí}*œMÚa≤”Ê∂˘öàëX 	¡ŒÏúÚIÔN˚†)M¶y”yë_\œihÊ+ÑπEà©ÄáùÈœ^?≠kM=óÿ„∂ÜYÏ„kàºª8Aí9©l°Gs‘‡wW∞æ≈x«dSyë§>@üv6ûÁ”“¶“Ùºyñ7íÃ—lgF{Ä¡ú`©v„∞œ◊°†xmf‘gÇHÆÓmb‹à’[pn0§}”ådt„‚µ—Æ"ºm:qƒÂ√0∫î,Lﬁô„®«ˇ Æ©I≠ôî¢Ô¢2µJÁL[ùˆÒœ ò[¢ñŒÂv¡ /e<ìK•ôïDóò÷é_b.8Ó}ø“ó3}JÂi;#£¥“maId‘cö[D∑÷&V?8∆åqœojÕ∏◊óvZ´B´jMÃ/X}œsŒGn=x|œπ
/©ê⁄ùºÛ^AbÊ“}.DµÄê°.KÌı1?˛¥ΩûÍÁ…êáëÔcê.)88<ÒÔZsÆ