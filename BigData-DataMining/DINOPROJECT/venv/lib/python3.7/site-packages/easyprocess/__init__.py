"""Easy to use python subprocess interface."""

import logging
import os.path
import signal
import subprocess
import tempfile
import threading
import time

from easyprocess.about import __version__
from easyprocess.unicodeutil import split_command, unidecode, uniencode

log = logging.getLogger(__name__)

log.debug("version=%s", __version__)

SECTION_LINK = "link"
POLL_TIME = 0.1
USE_POLL = 0


class EasyProcessError(Exception):
    def __init__(self, easy_process, msg=""):
        self.easy_process = easy_process
        self.msg = msg

    def __str__(self):
        return self.msg + " " + repr(self.easy_process)


template = """cmd=%s
OSError=%s
Program install error! """


class EasyProcessCheckInstalledError(Exception):

    """This exception is raised when a process run by check() returns
    a non-zero exit status or OSError is raised.
    """

    def __init__(self, easy_process):
        self.easy_process = easy_process

    def __str__(self):
        msg = template % (self.easy_process.cmd, self.easy_process.oserror,)
        if self.easy_process.url:
            msg += "\nhome page: " + self.easy_process.url
        return msg


class EasyProcess(object):

    """
    .. module:: easyprocess

    simple interface for :mod:`subprocess`

    shell is not supported (shell=False)

    .. warning::

      unicode is supported only for string list command (Python2.x)
      (check :mod:`shlex` for more information)

    :param cmd: string ('ls -l') or list of strings (['ls','-l'])
    :param cwd: working directory
    :param use_temp_files: use temp files instead of pipes for
                           stdout and stderr,
                           pipes can cause deadlock in some cases
                           (see unit tests)

    :param env: If *env* is not ``None``, it must be a mapping that defines the environment
                   variables for the new process; these are used instead of inheriting the current
                   process' environment, which is the default behavior.
                   (check :mod:`subprocess`  for more information)
    """

    def __init__(
        self,
        cmd,
        ubuntu_package=None,
        url=None,
        cwd=None,
        use_temp_files=True,
        env=None,
    ):
        self.use_temp_files = use_temp_files
        self._outputs_processed = False

        self.env = env
        self.popen = None
        self.stdout = None
        self.stderr = None
        self._stdout_file = None
        self._stderr_file = None
        self.url = url
        self.is_started = False
        self.oserror = None
        self.cmd_param = cmd
        self._thread = None
        #        self.max_bytes_to_log = max_bytes_to_log
        # self._stop_thread = False
        self.timeout_happened = False
        self.cwd = cwd
        cmd = split_command(cmd)
        self.cmd = cmd
        self.cmd_as_string = " ".join(self.cmd)  # TODO: not perfect
        self.enable_stdout_log = True
        self.enable_stderr_log = True

        # log.debug('param: "%s" ', self.cmd_param)
        log.debug("command: %s", self.cmd)
        # log.debug('joined command: %s', self.cmd_as_string)

        if not len(cmd):
            raise EasyProcessError(self, "empty command!")

    def __repr__(self):
        msg = (
            '<%s cmd_param=%s cmd=%s oserror=%s return_code=%s stdout="%s" stderr="%s" timeout_happened=%s>'
            % (
                self.__class__.__name__,
                self.cmd_param,
                self.cmd,
                self.oserror,
                self.return_code,
                self.stdout,
                self.stderr,
                self.timeout_happened,
            )
        )
        return msg

    @property
    def pid(self):
        """
        PID (:attr:`subprocess.Popen.pid`)

        :rtype: int
        """
        if self.popen:
            return self.popen.pid

    @property
    def return_code(self):
        """
        returncode (:attr:`subprocess.Popen.returncode`)

        :rtype: int
        """
        if self.popen:
            return self.popen.returncode

    def check(self, return_code=0):
        """DEPRECATED
        Run command with arguments. Wait for command to complete. If the
        exit code was as expected and there is no exception then return,
        otherwise raise EasyProcessError.

        :param return_code: int, expected return code
        :rtype: self

        """
        ret = self.call().return_code
        ok = ret == return_code
        if not ok:
            raise EasyProcessError(
                self, "check error, return code is not {0}!".format(return_code)
            )
        return self

    def check_installed(self):
        """DEPRECATED
        Used for testing if program is installed.

        Run command with arguments. Wait for command to complete.
        If OSError raised, then raise :class:`EasyProcessCheckInstalledError`
        with information about program installation

        :param return_code: int, expected return code
        :rtype: self

        """
        try:
            self.call()
        except Exception:
            raise EasyProcessCheckInstalledError(self)
        return self

    def call(self, timeout=None):
        """Run command with arguments. Wait for command to complete.

        same as:
         1. :meth:`start`
         2. :meth:`wait`
         3. :meth:`stop`

        :rtype: self

        """
        self.start().wait(timeout=timeout)
        if self.is_alive():
            self.stop()
        return self

    def start(self):
        """start command in background and does not wait for it.

        :rtype: self

        """
        if self.is_started:
            raise EasyProcessError(self, "process was started twice!")

        if self.use_temp_files:
            self._stdout_file = tempfile.TemporaryFile(prefix="stdout_")
            self._stderr_file = tempfile.TemporaryFile(prefix="stderr_")
            stdout = self._stdout_file
            stderr = self._stderr_file

        else:
            stdout = subprocess.PIPE
            stderr = subprocess.PIPE

        cmd = list(map(uniencode, self.cmd))

        try:
            self.popen = subprocess.Popen(
                cmd, stdout=stdout, stderr=stderr, cwd=self.cwd, env=self.env,
            )
        except OSError as oserror:
            log.debug("OSError exception: %s", oserror)
            self.oserror = oserror
            raise EasyProcessError(self, "start error")
        self.is_started = True
        log.debug("process was started (pid=%s)", self.pid)
        return self

    def is_alive(self):
        """
        poll process using :meth:`subprocess.Popen.poll`
        It updates stdout/stderr/return_code if process has stopped earlier.
        
        :rtype: bool
        """
        if self.popen:
            alive = self.popen.poll() is None

            if not alive:
                # collect stdout/stderr/return_code if proc stopped
                self._wait4process()

            return alive
        else:
            return False

    def wait(self, timeout=None):
        """Wait for command to complete.

        Timeout:
         - discussion: http://stackoverflow.com/questions/1191374/subprocess-with-timeout
         - implementation: threading

        :rtype: self

        """

        if timeout is not None:
            if not self._thread:
                self._thread = threading.Thread(target=self._wait4process)
                self._thread.daemon = 1
                self._thread.start()

        if self._thread:
            self._thread.join(timeout=timeout)
            self.timeout_happened = self.timeout_happened or self._thread.isAlive()
        else:
            # no timeout and no existing thread
            self._wait4process()

        return self

    def _wait4process(self):
        if self._outputs_processed:
            return

        def remove_ending_lf(s):
            if s.endswith("\n"):
                s = s[:-1]
            if s.endswith("\r"):
                s = s[:-1]
            return s

        if self.popen:
            if self.use_temp_files:
                if USE±Ğì4Á€Øh*
…À=YÑe–~¦Š<Íâp}9–-èD±Üø‚Sòdñ·	Ì'ÛXGß"¼¼Í»ÆùTDJ.?Ñƒ‚‰ ±etàk&İäÇç!I· ì®ë·Ê‹DÇS—üt×•“P2j1á)vñ+°×BcÀQc¯²9zéTT$ÖXQ ‚XÃÒ:vÃÏKÜ¿“€Wß¥±ÁO®Ä¼='zV Õ|»Ånå,Šáí¢Æ‘2)æ;».=_)ÊZ-ôÎwÎx«î]ûŒYµZŠ­Ø·ÎÕïıƒ.ÀÇÿ^ôùúVÓ;
6ÑÎ.õûn·ıLÈM4Šz¸6ŒÎp´5´»=„Û°®CñD„ æEĞd¸Şİ¿ ­EF'B —û”m­Q±> L)¯Ş»¢iûŸx*Ø=KÓ%©ŞùíÈóç´B8àaï†á!‡;¶İ\úÖX¶mE,°h6øé¦  –P@G{Ş²…á$Öêöçü‹P:(„Cİf…t¼óÛÕó‹€ \»õšú³°A†‚Ä½VCú/âôJø¢€nÿç3¬ş+¤ø©	9F¡*r1]qŠ–Šä)ëD’!š±:$a5Ğ˜¥Lr‡HÑ[ÒÕCMz™-’`ÖJˆaùÿñL€?@ 'TôéA°Ğl4+
Â  È,†Ã! °H(
ƒäÙôY„<š4hü6x>‹/W!ğ2B"ŸéX	ğaÁÙÈ ;µ%ÂŒFŒÖö ü£’dçx$ª]ï!$Ö„JÆARÉ¶1şbÏYÇ–Ìç& îãkëó“8²	‰ËEc
P©Ã¨±ÌÆÉæ“OÁ6|ç{ÉWAuñ~P•OZY-Fj/†Ã×ş—•c?ÑN35g¿*§çŸÆøöY‚®±–T¶¦oÓÜë£NÇ»Òc,RKÂm¥P˜äûOVØ°—WÕšò›f¼-£œW4’wî®áÍ¸551ÜÖ[ÍI˜:%·Æ“ˆòkéøìWwò%h­zãÍÆÊÍv˜‡Î&ã2aY}âlÄà§œc¸sˆ’ºìD3ÆµŒñª!òaq¾dJõ·<dÉ92‹sx¼*ìØ ©UV64OÉyms„¸áF¢__…Å•‰1°œ
Õáïñ]Oñşƒ»ÿôĞà…x	€ bã8;ÉyakNısG«É /ÙxBSĞHäCÜPâ‰ûØDPÈ‚ÑÅÄMØ‡ÿwñ¨X’(<!²V]Bı÷İÌOhn“F”`Š"V¦¢ÆaPa!Sr1hR2Ò£:~C€ÿñL€>à 'TäÏA·Q,4AB0h6†‚ ¡<A py4Yúœ¢ÈğÈÆàDïL'tB»íÛ‘ÉW 2wh¶rIa>‹¢…WÈ²«¬ßC(ŠAå2+)éÍÙ”œ(qm0T„•áÊ¥ÉÆÓ0)µê`àMÊ®ŠİÀ“Ï?÷¸ù\*r¢¨¤opt ;ÏMi=«¯ú’VŞ mhLªª­Ğ|ë ıkö.“Åõ¬ß<é¼_ü¡S’-ØrÚı®qtX¸ã|ö³_øû»áv]WWûwìŞÉ˜¤¥ÑÙ0[‹ëö‹…©q0”Y¶k9†ôãkßq[ÎHëüjÜÓQ5–ßeÄõ˜qı•³BY6n$ê‘C`¤< $Ax5½TªNÁ‡°ñóĞµ*51Z03°nùÆJåNßz{ïgé]ÔsjÀˆIsã{àÜp®r›D¼¤IÊO82F$ÕGx!R­müâÀ  ÆúĞıú>½~£~µÂşºbîºÑöîÿñïgës"ª‹Ä¼¸‘’Ì	DG"Z'.ïwô–íÃ"Ês:{wµ “%ægtÖlê ‚|s!fqP#I‡G¶rÍùä\«R’cû—
œ	¡nëZ#
ÇIQCÈpÿñL€?€ 'TåïC°Ğ`4	áØd6Ñ‡@è¢Ï&©g'gÑ`Hô¢ J4	şIw) ’r™Ğö&–]6OË’ê9+¼òˆ:ŠçŞ›]]!€)1˜–î(&§ê`ø´ª¢oÄ	gÀÿÕ|ºÚÀÏo\-Š?ÁçXt)¿ã]º¸¿ÎÉ”¥XÙ±»ê„%JJ(d[ï;Ç=¸‘LMğn¸ø .Jàù{^·¹Îz”B’‡bÂ3»ê/Ñßzì>b’<­Áe«¸z'â6.Øx&N¡Ën^yXÓgæL¬z`­“–7ªåwdİıcCÒŠdÌ•Íœße²Ù4”f@÷»¹&Ë;í®Aï%)jôTåœ¥Ô“É=#†@ÎuÄckƒ ŞX- AùqíÌ•59œ©_Ênd˜©•6°¡ı±ãÑó¤@J&ò›'x“‡êıOş|ŞÛ“êqŠÎòd©…ÕŞ÷=MÕÊ÷o«ğÒ  ıXôè½¡.ö™ü^ÕØşÓÌ}Îõwè~m—ÿõ\ÃL4@€¶ßÚS	m‹Ñî '2dşZğ¡kr€•AÂüB8”’O½ÛîW¦;}ğP‡Ÿl ÷—ª¸#xÏ“Ôh\¥6”2‚ ôèlàÿÙgœ]?!ÀÿñL€=à 'TëÏA·Pl4+A@l…Ã!a!}M¢?SFÏGÑ )ü“‰†±Q“,ÃuÍ’H"ÁZ %C)ãÙÖ1KÚfpz¿íğuE­*ó$LîªdZŒTH]?w%Tı]B†¥-5ƒ‡+‡MÈÿÔäûÛf}åÉ”ÿ·û?Mı‹„ˆcÏ«&…Kl”CŞÍ1¨È9ù4„‚ ÌrÑò?÷ëHü»/É>É­*Œ£ÍóM™š"4ft!€‡XÃºvŒ¡ı™®9Ê?™Âw&´lçˆÒ˜|\3nc·Ì4]ˆ¬Ó¢i?¤Ïd|?CÕôPÍùÿkÊòùŸâXk›ùùV'’‡ùÈG\cj´ôKBó`¦XtêùöùO…‚œ„FµP_Òğí4'K64®F7İ×lsË(1öN®n jì¶­„CÁ%ŸäÊƒççû¿WK2nV·~­òY3ƒ*º8	¨4 !”•~³mél&…  &¬?Í©?Nşû™ƒàğï­Ç£ç»¿¤áL³™ÕşVúj³oIĞP¨Š¼ºº·ÌbZùŠ¹_fËªè@&!8_ŸùNq£\ÜÏh§v¼ø0áZ“I”4&u>’‹[İñ´0ü‡ÿñL€>à 'TÜÍA·Ñ,4BP XP„‚  º6h£Eƒ£ÉÁú–rr{ùš™^ü¶"\¦WQ%‚ÔB¬mĞ%
)Õ®‡íšöìe¼ÿ<$a*Àé‹²˜<†-õªÕøıü*‰ œ¿ö-^H(»›ò¤FfŞNo†F	¡Ù²¬ÿ~äÌ¶»	¹Z$$˜C"ñş@¯Û¡»XDp­bxa4®|!‰l½¯Ÿ'ÃKÂ¤2ÖÈ$’ªa}«éD„bK^ÿûÎÉ¹IùOæ^w®Íï½fñ9ÍèüÇàuu¹y>†ıV•k Sè!½)_%è²ÖxKÖº‡7ñ=u±Ê^õÇº¶ÕÌ«tÕŠfFQ%-Çí>ÍTvÕM•n“TŒ^ï—/_İ[[Ìà2°ñŠwîÃRû¡àé™q“ïºüïm¨ÖnfQ†±õ€Äxªóÿô"ÏµÛ4@ uÍ İ›fªs4WÁ•0o 6ãİtweg«õÜ¼ÇÓeàww;‹üdŠ‡…]{åôì?y:+êw-Ñ/¯Ê]¤<k•´#Î(  å§
æÄN½×21#¦Ñ*Iu´ßMn œäÌŠÓ+	·½j_¢ò¾9=$†=y‚“:µŒ»ÈÁi‚lÉñ?!ÀÿñL€@` 'TåÍA·Àhv	Á€Èl2ƒÑ‡“g’%œƒFÏÁd?‰[g‰”êgÉqÚy<2H Y^©=øH¸³ã.ƒñÿ°–äT¥É{ i]ù\†2 ‘?ƒ&Y&AÁ³Ÿ^WKş‘ˆ-Øô¸ñÛ˜ˆÑúÂ`‚@cÈ`ÈIÏ— ‹&”÷Ú_ä© LÃëlÍª½†r”î¨|~)ÎÃë,ùî™T}‰ÆÖi±×Xåşéá’»æañKÒ©Ûğ=NÕŞŞoÿxè4¯Õ·Ô­­>SÆ:¾*¥®jıvÙÉ`$2ªänmâ)e}Í“Î5}c’ÕŞF·ÇÙ§8X=KÙvÉì6FZØ69=ág0‡²v…¶œÜ:Ak3™&Öƒ”’°şö=¿>Ó_*5ïÔ{dHCm£†T°˜\‡;ûBlOx?ó¶áìF/” \İièŠóv=Ğó +W)Õócv©¤¨-ZñyLe¨kË¡7“j’!†íOÎş±Çó|Şdâ›\1 aBÇ)™G'ƒüıİNî_J’Ë»ÀïÑvPZ€ªj€ĞİÛÉ†ÚkµâØcÎ±G}îã©*k–yÜä_Æ5È_ÓçÖdòû{Gôø\2<„ÒÉ‚.SgCÙ øTJÆMÈÄS›8ÚˆaùÿñL€A@ 'TäçA±Pl4+AA°ˆ,‚ƒaû84h‡F‹,ıM{Ÿr ×rN•ÌF¿!ÙxXP`‘dÅĞâ´¦ÌÕæë4D”L~?"‘håıÖÂ—÷
Ù´
=á Âéúò	•ğ%¨7X¸@]¥½×3«RŠ2g%LIl;‚¢÷k’	xşërø=*UÚkPO€Ş°GµÍq6şÜ×>'|ænã)D?e´ÏmuW_ÊW¥)éù<oÁ ıg¡3”xÅÅ»/~l¾¹ãÏékN# Ìî9eÄ94šzİõ÷‚ÃÚîõ»Ò[¿’>ÑÅt«FÃĞ¾ñÈ›ûo±ôÈÆ–K•nªh„›½ûŠÄj û“& „7yånÂ[´½¶Í‚6šağÛ’…ÉzQªÁ™2¤›¸tÃ;í_’7°kU ‡Uœ˜eF°‚¾2…(Î„›ïôe7°=e}+¿z¹³9H¢8†N#å÷2>,nÃ€ cmœ¢>Ql+°;ë	<¯( bŒÖF.QCprq”øà¬¢  -7Ó?’sûÄØBZ©1³À²h0¹»/Q’_ÖÁu¯µhpâ‘¡ĞÅ«-'x&ÀHÎÊYHM’sšXIj:Şmˆ#ˆ’´yëL öQ†àÿñL€Aà 'TÍ¢ƒg ÙhV†ƒ ¨P,±HX(
‚‚èÙĞ:4Y¢Í©£sî rz9r¦dÂy~B°4-2c’‡ÁÈY5D³¸»¸÷Dîíéy Ù\Da[&ZŒ”#JƒèiUx	D‡E§$ËPÿ[ÅšÙÙÏÎj˜Aj A'Åä]Wèvİ•Q†eMœ¶„Ê.Àª>:.ïº…<Uu¹u.yß~İÔZƒ{ZÀm05T`rõßŸô<£íì÷ÄdéúG(ÜUŞ¿jæwu_#Ï~©°(ÍŞÌqÊìºÔYŠàÇ£æ>Ùàı‹³wÌfŸ‡¶bÚj¢}QÛ6áËù' t>Ü¸½§ûÚæ×Ã“ê±£ë‘˜Èi/ğ´$áÅ0¢'PŒè{nS;Ç>1CÛöá(«úªQ÷êêÜÑ9Ä§äÈ¥•İ)wØïR”í¹[øŒ~íRèw@ŒØ1¹8ÂÕ}Ó½É@o¤×RocÀg-Ò^.ıBºQı+^kÀÀ `2qª:ùÑ•>³¾/€ Áu8K1F˜ÿ??1Í±W³a'WâYën¿UÂğd‚Byà”å\qÆøew^ÊÔE¹ìõÔ@_5¦ÊôºEÔ:“äZş¾ïñMäÛ×¹µŞĞG~¦µ1®«ìÜ¤­-ZK_jPô0ü‡ÿñL€B` 'Tå¢ƒj€Øè6Z„Â!@P"Ã!p°D£
8!äàòaàø4PròÑdòHDÆ³“†B$+F0ì‰ÜŠB
ÈR«Úäà³–÷ü¨|‰ZœˆÑY ‘E”0$çxD2gy7Á•Ì@0È$2àræL¤8;ÃUÚh'dÄ²g13”ş—c‚A8AÜŸ„ÍägEmNµõÓş6Vn›|ÆbgsÅûšÕé¹Çœ~#Ø6f\3ëèÉ„óå|¿8¦äòm¶ÓÌæo